<!DOCTYPE html>
<html>
<head>
  <title>Josh's MLB Game Log</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(to bottom, #f9f9f9, #e6e6e6);
      color: #111;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }

    h1 {
      text-align: center;
      color: #0c2340;
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    h2 {
      color: #0c2340;
      border-bottom: 2px solid #0c2340;
      padding-bottom: 5px;
      margin-top: 40px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      background-color: #fff;
      border-radius: 8px;
      overflow: hidden;
    }

    th {
      background-color: #0c2340;
      color: white;
      text-align: center;
      padding: 12px;
      font-size: 0.95em;
    }

    td {
      padding: 10px;
      text-align: center;
      border-bottom: 1px solid #eee;
    }

    tr:nth-child(even) {
      background-color: #f7f7f7;
    }

    tbody tr:hover {
      background-color: #dbe9ff;
      transition: 0.2s;
    }

    button {
      padding: 10px 16px;
      font-size: 1em;
      color: white;
      background-color: #0c2340;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: 0.2s;
      margin-bottom: 10px;
    }

    button:hover {
      background-color: #115293;
    }

    .warning {
      color: red;
      font-size: 0.9em;
      margin-top: 10px;
    }

    #leadersContainer {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }

    .leaderboardBox {
      flex: 1 1 200px;
      background-color: #f0f8ff;
      border-left: 5px solid #0c2340;
      border-radius: 6px;
      padding: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .leaderboardBox h3 {
      margin-top: 0;
      color: #115293;
    }

    .leaderboardBox ol {
      padding-left: 20px;
      margin-top: 5px;
    }

    #yankeesRecord {
      font-weight: bold;
      font-size: 1.2em;
      margin-top: 10px;
      padding: 10px;
      background-color: #f0f8ff;
      border-left: 5px solid #0c2340;
      border-radius: 4px;
    }
  </style>
</head>
<body>

<h1>Josh's MLB Game Log ‚öæ</h1>

<!-- Yankees Record First -->
<div class="section">
  <h2>My Yankees Record</h2>
  <div id="yankeesRecord">Wins: 0 | Losses: 0</div>
</div>

<!-- Player Leaderboards Second -->
<div class="section">
  <h2>Player Leaderboards (Games I've Attended)</h2>
  <div id="leadersContainer"></div>
</div>

<!-- Games Attended Last -->
<div class="section">
  <h2>Games Attended (<span id="count">0</span>)</h2>
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Away</th>
        <th>Home</th>
        <th>Score</th>
        <th>Stadium</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
  <div id="unmatched" class="warning"></div>
</div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQdTK9Y2OsQTjWCNXjc2tx6OTfAM0vDA_t1o82WRkbf_xj-9Pipnu-DC4wDXDso2J3kQz23pEyN30Fh/pub?output=csv";

const TEAM_MAP = {
  "Yankees": "New York Yankees",
  "Red Sox": "Boston Red Sox",
  "Blue Jays": "Toronto Blue Jays",
  "Orioles": "Baltimore Orioles",
  "Rays": "Tampa Bay Rays",
  "Rangers": "Texas Rangers",
  "White Sox": "Chicago White Sox",
  "Twins": "Minnesota Twins",
  "Guardians": "Cleveland Guardians",
  "Royals": "Kansas City Royals",
  "Athletics": "Oakland Athletics",
  "Angels": "Los Angeles Angels",
  "Mariners": "Seattle Mariners",
  "Diamondbacks": "Arizona Diamondbacks",
  "Rockies": "Colorado Rockies",
  "Dodgers": "Los Angeles Dodgers",
  "Giants": "San Francisco Giants",
  "Padres": "San Diego Padres",
  "Cubs": "Chicago Cubs",
  "Brewers": "Milwaukee Brewers",
  "Pirates": "Pittsburgh Pirates",
  "Cardinals": "St. Louis Cardinals",
  "Mets": "New York Mets",
  "Phillies": "Philadelphia Phillies",
  "Nationals": "Washington Nationals",
  "Marlins": "Miami Marlins",
  "Reds": "Cincinnati Reds",
  "Tigers": "Detroit Tigers",
  "Braves": "Atlanta Braves"
};

let games = [];

async function loadGames() {
  const res = await fetch(CSV_URL);
  const text = await res.text();
  const rows = text.trim().split("\n");
  const headers = rows.shift().split(",").map(h => h.trim());

  games = rows.map(r => {
    const values = r.split(",");
    const obj = {};
    headers.forEach((h,i)=> obj[h] = values[i]?.trim());
    obj.awayScore = parseInt(obj.AwayScore);
    obj.homeScore = parseInt(obj.HomeScore);
    // Only count wins/losses when Yankees are playing
    if(obj.Home === "Yankees" || obj.Away === "Yankees") {
      obj.yankeesWin = (obj.Home === "Yankees" && obj.homeScore > obj.awayScore) ||
                       (obj.Away === "Yankees" && obj.awayScore > obj.homeScore);
    } else {
      obj.yankeesWin = null; // ignore other games
    }
    return obj;
  });

  // Sort by date descending
  games.sort((a,b)=> new Date(b.Date) - new Date(a.Date));

  renderTable();
  updateLeaderboards(); // auto-generate leaderboards
}

function renderTable() {
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";
  games.forEach(g => {
    tbody.innerHTML += `<tr>
      <td>${g.Date}</td>
      <td>${g.Away}</td>
      <td>${g.Home}</td>
      <td>${g.awayScore}-${g.homeScore}</td>
      <td>${g.Stadium}</td>
    </tr>`;
  });
  document.getElementById("count").textContent = games.length;
  updateYankeesRecord();
}

function updateYankeesRecord() {
  let wins=0, losses=0;
  games.forEach(g=>{
    if(g.yankeesWin === true) wins++;
    if(g.yankeesWin === false) losses++;
  });
  document.getElementById("yankeesRecord").innerText = `Wins: ${wins} | Losses: ${losses}`;
}

async function attachGamePks() {
  const unmatched = [];
  for (let game of games) {
    if (game.gamePk) continue;
    const date = game.Date;
    const res = await fetch(`https://statsapi.mlb.com/api/v1/schedule?sportId=1&date=${date}`);
    const data = await res.json();
    if (!data.dates.length) continue;

    const awayName = TEAM_MAP[game.Away] || game.Away;
    const homeName = TEAM_MAP[game.Home] || game.Home;

    const found = data.dates[0].games.find(g =>
      g.teams.away.team.name.toLowerCase().trim() === awayName.toLowerCase().trim() &&
      g.teams.home.team.name.toLowerCase().trim() === homeName.toLowerCase().trim()
    );

    if (found) game.gamePk = found.gamePk;
    else {
      unmatched.push({
        Date: game.Date,
        Away: game.Away,
        Home: game.Home,
        APIOptions: data.dates[0].games.map(g=>`${g.teams.away.team.name} @ ${g.teams.home.team.name}`)
      });
    }
  }

  const unmatchedDiv = document.getElementById("unmatched");
  if (unmatched.length) {
    unmatchedDiv.innerHTML = "<b>Unmatched games (check CSV):</b><br>" + unmatched.map(u =>
      `${u.Date}: ${u.Away} @ ${u.Home} <br>Possible API matches: ${u.APIOptions.join(" | ")}`
    ).join("<br><br>");
  } else {
    unmatchedDiv.innerHTML = "";
  }
}

async function generateLeaderboards() {
  const stats = {};
  for (const game of games) {
    if(!game.gamePk) continue;
    const res = await fetch(`https://statsapi.mlb.com/api/v1.1/game/${game.gamePk}/feed/live`);
    const data = await res.json();
    const teams = data.liveData.boxscore.teams;

    ["home","away"].forEach(side => {
      Object.values(teams[side].players).forEach(p=>{
        const name = p.person.fullName;
        if(!stats[name]) stats[name]={hits:0, atBats:0, ks:0, ip:0, hr:0, hbp:0, walks:0};
        const b = p.stats?.batting;
        const pi = p.stats?.pitching;
        if(b){ 
          stats[name].hits += b.hits || 0;
          stats[name].atBats += b.atBats || 0;
          stats[name].hr += b.homeRuns || 0;
          stats[name].hbp += b.hitByPitch || 0;
          stats[name].walks += b.baseOnBalls || 0; // walks
        }
        if(pi){
          stats[name].ks += pi.strikeOuts || 0;
          stats[name].ip += parseFloat(pi.inningsPitched||0);
        }
      });
    });
  }

  const players = Object.entries(stats).map(([name,s])=>({
    name, hits:s.hits, atBats:s.atBats, ks:s.ks, ip:s.ip, hr:s.hr, walks:s.walks, hbp:s.hbp, avg:s.atBats>0?s.hits/s.atBats:0
  }));

  const topHits   = [...players].sort((a,b)=>b.hits-a.hits).slice(0,10);
  const topKs     = [...players].sort((a,b)=>b.ks-a.ks).slice(0,10);
  const topAB     = [...players].sort((a,b)=>b.atBats-a.atBats).slice(0,10);
  const topAVG    = [...players].filter(p=>p.atBats>=10).sort((a,b)=>b.avg-a.avg).slice(0,10);
  const topIP     = [...players].sort((a,b)=>b.ip-a.ip).slice(0,10);
  const topHR     = [...players].sort((a,b)=>b.hr-a.hr).slice(0,10);
  const topWalks  = [...players].sort((a,b)=>b.walks-a.walks).slice(0,10);
  const topHBP    = [...players].sort((a,b)=>b.hbp-a.hbp).slice(0,10);

  function renderList(title,list,formatter){
    let icon = "";
    if(title.includes("Hits")) icon = "‚öæ";
    if(title.includes("Strikeouts")) icon = "üèÜ";
    if(title.includes("At Bats")) icon = "üìù";
    if(title.includes("Batting Average")) icon = "üìä";
    if(title.includes("Innings Pitched")) icon = "üéØ";
    if(title.includes("Home Runs")) icon = "üí•";
    if(title.includes("Walks")) icon = "üèÉ";
    if(title.includes("Hit By Pitch")) icon = "ü§ï";

    let html = `<div class="leaderboardBox"><h3>${icon} ${title}</h3><ol>`;
    list.forEach(p=>html+=`<li>${p.name} - ${formatter(p)}</li>`);
    html += "</ol></div>";
    return html;
  }

  document.getElementById("leadersContainer").innerHTML =
    renderList("Top 10 Hits",topHits,p=>p.hits) +
    renderList("Top 10 Strikeouts (Pitching)",topKs,p=>p.ks) +
    renderList("Top 10 At Bats",topAB,p=>p.atBats) +
    renderList("Top 10 Batting Average (Min 10 AB)",topAVG,p=>p.avg.toFixed(3)) +
    renderList("Top 10 Innings Pitched",topIP,p=>p.ip) +
    renderList("Top 10 Home Runs",topHR,p=>p.hr) +
    renderList("Top 10 Walks",topWalks,p=>p.walks) +
    renderList("Top 10 Hit By Pitch",topHBP,p=>p.hbp);
}

async function updateLeaderboards(){
  await attachGamePks();
  generateLeaderboards();
}

loadGames();
</script>

</body>
</html>